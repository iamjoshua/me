---
import { getCollection } from "astro:content";
import { cn } from "@/lib/utils";

interface Props {
  currentCategory?: string;
  currentSubject?: string;
  basePath?: string;
}

const { currentCategory, currentSubject, basePath = "/readings" } = Astro.props;

const readings = await getCollection("readings");

// Filter readings by category if specified
let filteredReadings = readings;
if (currentCategory) {
  filteredReadings = readings.filter((reading) => reading.data.category === currentCategory);
}

// Get subjects from filtered readings
const subjects = [
  ...new Set(filteredReadings.map((reading) => reading.data.subject).filter(Boolean)),
].sort();

const subjectCounts = subjects.reduce((acc, subject) => {
  acc[subject] = filteredReadings.filter((reading) => reading.data.subject === subject).length;
  return acc;
}, {});

const subjectItems = subjects.map((subject) => {
  // Find the category for this subject
  const subjectCategory = filteredReadings.find(reading => reading.data.subject === subject)?.data.category;
  
  return {
    label: subject
      .split(" ")
      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
      .join(" "),
    count: subjectCounts[subject],
    href: `${basePath}/${subjectCategory.replace(/ /g, "_")}/${subject.replace(/ /g, "_")}`,
    isActive: currentSubject === subject,
  };
});
---

{subjectItems.length > 0 && (
  <div class="w-screen lg:w-full space-y-2 mb-6 lg:max-w-5/6 overflow-hidden lg:overflow-visible">
    <div class="flex flex-nowrap lg:flex-wrap gap-2 px-5 lg:px-0 overflow-x-scroll lg:overflow-hidden pb-5">
      {subjectItems.map((item) => (
        <a
          href={item.href}
          class={cn(
            "min-w-fit flex items-center px-3 py-1 text-xs border rounded-full text-gray-700 hover:border-gray-400 transition-colors border-gray-200",
            item.isActive && "border-transparent bg-slate-600 text-white",
          )}
        >
          {item.label}
          <span
            class={cn(
              "inline-block px-2 py-1 ml-3 -mr-2 text-[10px] bg-gray-200 text-gray-600 rounded-full",
              item.isActive && "bg-slate-700/50 text-slate-200",
            )}
          >
            {item.count}
          </span>
        </a>
      ))}
    </div>
  </div>
)}